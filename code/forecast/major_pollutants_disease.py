import os
import pandas as pd
import numpy as np
from sklearn.ensemble import RandomForestRegressor

# Path to the folder containing CSV files
folder_path = '../../countrywise_dataset'

# Columns to use for correlation calculation
columns = ['Cardiovascular diseases', 'Lower respiratory infections', 'Neonatal disorders',
           'Environmental heat and cold exposure', 'Diabetes mellitus', 'Chronic kidney disease',
           'Chronic respiratory diseases', 'CO', 'NMVOC', 'NOX', 'PM10', 'PM2-5', 'SOX']

# Create an empty DataFrame to store the common pollutant for each disease
common_pollutants_df = pd.DataFrame(columns=['Country', 'Disease', 'Pollutant'])

def visualize_top_pollutants(country, data):
    # Replace NaN values with zeros
    data.fillna(0, inplace=True)
    # Extract disease columns
    disease_columns = data.columns[2:9]  # Extract only disease columns
    # Calculate the total impact of each disease
    disease_impact = data[disease_columns].sum()
    # Select the top 3 diseases based on total impact
    top_3_diseases = disease_impact.nlargest(3).index.tolist()
    
    # Extract pollutants columns
    pollutants_columns = data.columns[9:]  # Extract pollutants columns
    # Prepare features and target
    X = data[pollutants_columns]
    for disease in top_3_diseases:
        y = data[disease]
        # Perform Random Forest regression
        rf = RandomForestRegressor()
        rf.fit(X, y)
        # Find the most influential pollutant
        most_influential_pollutant = pollutants_columns[np.argmax(rf.feature_importances_)]
        # Append the result to the common pollutants DataFrame
        common_pollutants_df.loc[len(common_pollutants_df)] = [country, disease, most_influential_pollutant]

# Iterate through all CSV files in the folder
for file_name in os.listdir(folder_path):
    if file_name.endswith('.csv'):
        csv_file_path = os.path.join(folder_path, file_name)
        # Read the CSV file
        country = os.path.splitext(file_name)[0]  # Extract country name from file name
        data = pd.read_csv(csv_file_path)
        # Call the function to visualize top pollutants for each disease
        visualize_top_pollutants(country, data)

# Save the common pollutants DataFrame to a CSV file
common_pollutants_df.to_csv('common_pollutants.csv', index=False)
